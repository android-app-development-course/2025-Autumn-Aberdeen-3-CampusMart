<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.CampusMart.web.mapper.MessageMapper">
    <resultMap id="MessageVoResultMap" type="org.example.CampusMart.web.vo.MessageVo">
        <result column="messageID" property="messageID"/>
        <result column="senderID" property="senderID"/>
        <result column="receiverID" property="receiverID"/>
        <result column="message_content" property="messageContent"/>
        <result column="sendTime" property="sendTime"/>
        <result column="senderNickname" property="senderNickname"/>
        <result column="senderAvatarURL" property="senderAvatarURL"/>
        <result column="receiverNickname" property="receiverNickname"/>
        <result column="receiverAvatarURL" property="receiverAvatarURL"/>
    </resultMap>

    <select id="selectMessageListWithUser" resultMap="MessageVoResultMap">
        SELECT
        m.messageID,
        m.senderID,
        m.receiverID,
        m.message_content,
        m.sendTime AS sendTime,
        u1.Nickname AS senderNickname,
        u1.avatarURL AS senderAvatarURL,
        u2.Nickname AS receiverNickname,
        u2.avatarURL AS receiverAvatarURL
        FROM
        message m
        JOIN
        `user` u1 ON m.senderID = u1.userID
        JOIN
        `user` u2 ON m.receiverID = u2.userID
        ${ew.customSqlSegment}
        ORDER BY m.sendTime ASC
    </select>

    <resultMap id="RecentChatVoResultMap" type="org.example.CampusMart.web.vo.RecentChatVo">
        <result column="otherUserID" property="otherID"/>
        <result column="otherUserNickname" property="otherNickname"/>
        <result column="otherUserAvatar" property="otherAvatarURL"/>
        <result column="lastMessage" property="lastestMessage"/>
        <result column="lastMessageTime" property="lastestMessageTime"/>
    </resultMap>

    <select id="selectRecentChats" resultMap="RecentChatVoResultMap">
        SELECT
            otherUser.userID AS otherUserID,
            otherUser.Nickname AS otherUserNickname,
            otherUser.avatarURL AS otherUserAvatar,
            latestMsg.message_content AS lastMessage,
            latestMsg.sendTime AS lastMessageTime
        FROM
            (SELECT
                 LEAST(senderID, receiverID) AS userX,
                 GREATEST(senderID, receiverID) AS userY,
                 MAX(sendTime) AS maxSendTime
             FROM message
             WHERE senderID = #{userId} OR receiverID = #{userId}
             GROUP BY userX, userY) AS dialog
                JOIN message latestMsg
                     ON ((latestMsg.senderID = dialog.userX AND latestMsg.receiverID = dialog.userY)
                         OR (latestMsg.senderID = dialog.userY AND latestMsg.receiverID = dialog.userX))
                         AND latestMsg.sendTime = dialog.maxSendTime
                JOIN `user` currentUser
                     ON currentUser.userID = #{userId}
                JOIN `user` otherUser
                     ON otherUser.userID = (CASE
                                                WHEN dialog.userX = #{userId} THEN dialog.userY
                                                ELSE dialog.userX
                         END)
        ORDER BY latestMsg.sendTime DESC
    </select>

</mapper>
